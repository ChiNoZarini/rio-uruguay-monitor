<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alturas Río Uruguay</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: #000000;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .main-display {
            text-align: center;
            animation: fadeIn 1s ease-in;
        }
        
        .height-display {
            font-size: 15rem;
            font-weight: 900;
            margin-bottom: 40px;
            text-shadow: 0 0 80px rgba(255, 255, 255, 0.3);
            line-height: 0.8;
            animation: slideIn 0.8s ease-out;
        }
        
        .line-separator {
            width: 800px;
            height: 4px;
            background-color: white;
            margin: 40px auto;
            animation: expandLine 0.6s ease-out 0.5s both;
        }
        
        .port-name {
            font-size: 4rem;
            font-weight: 700;
            letter-spacing: 15px;
            text-transform: uppercase;
            margin-top: 40px;
            animation: slideInUp 0.8s ease-out 0.7s both;
        }

        .tendency-display {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 20px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 5px;
            animation: slideIn 0.8s ease-out 0.3s both;
        }
        
        .loading {
            font-size: 2rem;
            opacity: 0.7;
            animation: pulse 2s infinite;
        }

        /* Subtle update indicator */
        .update-indicator {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 0.8rem;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }
        
        .update-indicator.updating {
            opacity: 0.8;
            animation: pulse 1s infinite;
        }

        .data-info {
            position: absolute;
            bottom: 30px;
            left: 30px;
            font-size: 0.8rem;
            opacity: 0.3;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInUp {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes expandLine {
            from { 
                width: 0;
                opacity: 0;
            }
            to { 
                width: 800px;
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .height-display { font-size: 12rem; }
            .line-separator { width: 600px; }
            .port-name { font-size: 3rem; letter-spacing: 12px; }
        }
        
        @media (max-width: 768px) {
            .height-display { font-size: 8rem; }
            .line-separator { width: 90vw; max-width: 400px; }
            .port-name { 
                font-size: 2rem; 
                letter-spacing: 8px;
                margin: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .height-display { font-size: 6rem; }
            .port-name { 
                font-size: 1.5rem; 
                letter-spacing: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="main-display">
        <div class="height-display" id="heightDisplay">--°</div>
        <div class="tendency-display" id="tendencyDisplay">CARGANDO...</div>
        <div class="line-separator"></div>
        <div class="port-name" id="portName">INICIANDO...</div>
    </div>
    
    <div class="update-indicator" id="updateIndicator">●</div>

    <div class="data-info" id="dataInfo">
        Río Uruguay - CARU
    </div>

    <script>
        let currentPortIndex = 0;
        let riverData = [];
        let isUpdating = false;
        let lastUpdateTime = 0;
        let onlineStatus = navigator.onLine;

        const heightDisplayEl = document.getElementById('heightDisplay');
        const tendencyDisplayEl = document.getElementById('tendencyDisplay');
        const portNameEl = document.getElementById('portName');
        const updateIndicatorEl = document.getElementById('updateIndicator');
        const dataInfoEl = document.getElementById('dataInfo');

        const API_URL = '/api/river-data';
        const UPDATE_INTERVAL = 10 * 60 * 1000; // 10 minutos
        const DISPLAY_INTERVAL = 3000; // 3 segundos por puerto

        // Lista de puertos principales del Río Uruguay para datos de demostración
        const PUERTOS_DATA = [
            'COLÓN', 'CONCEPCIÓN DEL URUGUAY', 'CONCORDIA', 'MONTE CASEROS', 
            'BELLA UNIÓN', 'SALTO', 'PAYSANDÚ', 'FRAY BENTOS',
            'GUALEGUAYCHÚ', 'FEDERACIÓN', 'PUERTO YERUÁ', 'SAN JAVIER',
            'ARTIGAS', 'CONSTITUCIÓN', 'PASO DE LOS LIBRES', 'URUGUAYANA',
            'MOCORETÁ', 'FEDERACIÓN EMBALSE', 'SALTO GRANDE ARRIBA', 'SALTO GRANDE ABAJO'
        ];

        // Función para generar datos realistas de demostración
        function generateDemoData() {
            console.log('Generando datos de demostración del Río Uruguay...');
            
            const tendencias = ['crece', 'baja', 'estacionado'];
            return PUERTOS_DATA.map((puerto, index) => {
                // Generar alturas realistas basadas en ubicación del puerto
                let baseHeight;
                
                // Alturas típicas por zona del río
                if (puerto.includes('SALTO GRANDE') || puerto.includes('FEDERACIÓN EMBALSE')) {
                    baseHeight = 30 + Math.random() * 10; // Represas: 30-40m
                } else if (puerto.includes('MONTE CASEROS') || puerto.includes('BELLA UNIÓN') || puerto.includes('ARTIGAS')) {
                    baseHeight = 4 + Math.random() * 4; // Curso superior: 4-8m  
                } else if (puerto.includes('CONCORDIA') || puerto.includes('SALTO') || puerto.includes('PAYSANDÚ')) {
                    baseHeight = 6 + Math.random() * 4; // Curso medio-superior: 6-10m
                } else if (puerto.includes('FRAY BENTOS') || puerto.includes('NUEVA PALMIRA')) {
                    baseHeight = 1 + Math.random() * 3; // Curso inferior: 1-4m
                } else {
                    baseHeight = 3 + Math.random() * 4; // Otros puertos: 3-7m
                }
                
                // Agregar variación estacional
                const month = new Date().getMonth();
                const seasonalFactor = Math.sin((month - 2) * Math.PI / 6) * 0.5;
                baseHeight += seasonalFactor;
                
                const tendency = tendencias[Math.floor(Math.random() * tendencias.length)];
                
                return {
                    puerto: puerto,
                    altura: parseFloat(baseHeight.toFixed(2)),
                    tendencia: tendency,
                    fecha: new Date().toLocaleDateString('es-AR') + ' - ' + 
                          new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit'}),
                    variacion: (Math.random() * 0.6 - 0.3).toFixed(2),
                    periodo: Math.random() > 0.5 ? '12 hs.' : '24 hs.',
                    lastUpdated: new Date().toISOString(),
                    source: 'DEMO_DATA',
                    standalone: true
                };
            });
        }

        async function fetchRiverData() {
            try {
                console.log('Intentando obtener datos del servidor...');
                const response = await fetch(API_URL, { 
                    timeout: 5000 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log('✅ Datos obtenidos del servidor local');
                    dataInfoEl.textContent = 'Río Uruguay - CARU (Datos Reales)';
                    return result.data;
                } else {
                    throw new Error(result.error || 'Error en la respuesta del servidor');
                }
            } catch (error) {
                console.log('⚠️  Servidor no disponible, usando datos de demostración');
                dataInfoEl.textContent = 'Río Uruguay - CARU (Datos de Demostración)';
                return generateDemoData();
            }
        }

        async function updateRiverData() {
            if (isUpdating || !onlineStatus) return;
            
            const now = Date.now();
            if (now - lastUpdateTime < 8 * 60 * 1000) { // Mínimo 8 minutos entre actualizaciones
                console.log('Datos recientes, saltando actualización');
                return;
            }
            
            isUpdating = true;
            updateIndicatorEl.classList.add('updating');
            
            try {
                const data = await fetchRiverData();
                
                // Solo actualizar si recibimos datos nuevos válidos
                if (data && data.length > 0) {
                    const oldCount = riverData.length;
                    riverData = data;
                    lastUpdateTime = now;
                    
                    console.log(`Datos actualizados: ${data.length} puertos (antes: ${oldCount})`);
                    
                    // Mostrar info de última actualización
                    const updateTime = new Date().toLocaleTimeString('es-AR');
                    const currentInfo = dataInfoEl.textContent.split(' - ')[0];
                    dataInfoEl.textContent = `${currentInfo} - Actualizado: ${updateTime}`;
                    
                    // Si estamos mostrando un puerto que ya no existe, resetear
                    if (currentPortIndex >= riverData.length) {
                        currentPortIndex = 0;
                    }
                } else {
                    console.log('No se recibieron datos válidos, manteniendo cache actual');
                }
                
            } catch (error) {
                console.error('Error al actualizar datos:', error);
                
                // Si no hay datos previos, usar datos de demostración
                if (riverData.length === 0) {
                    console.log('🔄 Generando datos de demostración...');
                    riverData = generateDemoData();
                    dataInfoEl.textContent = 'Río Uruguay - CARU (Datos de Demostración)';
                }
            } finally {
                isUpdating = false;
                updateIndicatorEl.classList.remove('updating');
            }
        }

        function displayCurrentPort() {
            if (riverData.length === 0) return;
            
            const portData = riverData[currentPortIndex];
            
            // Trigger animations
            heightDisplayEl.style.animation = 'none';
            tendencyDisplayEl.style.animation = 'none';
            portNameEl.style.animation = 'none';
            
            setTimeout(() => {
                portNameEl.textContent = portData.puerto;
                
                if (portData.error) {
                    heightDisplayEl.textContent = '--';
                } else {
                    const height = typeof portData.altura === 'number' ? 
                        portData.altura.toFixed(2) : portData.altura;
                    heightDisplayEl.textContent = height;
                }
                
                tendencyDisplayEl.textContent = portData.tendencia.toUpperCase();
                
                // Restart animations
                heightDisplayEl.style.animation = 'slideIn 0.8s ease-out';
                tendencyDisplayEl.style.animation = 'slideIn 0.8s ease-out 0.2s both';
                portNameEl.style.animation = 'slideInUp 0.8s ease-out 0.7s both';
            }, 50);
        }

        function nextPort() {
            if (riverData.length === 0) return;
            
            currentPortIndex = (currentPortIndex + 1) % riverData.length;
            displayCurrentPort();
        }

        // Inicializar aplicación
        async function init() {
            portNameEl.textContent = 'CARGANDO DATOS';
            heightDisplayEl.textContent = '--';
            tendencyDisplayEl.textContent = 'INICIANDO...';
            
            // Monitores de conexión
            window.addEventListener('online', () => {
                onlineStatus = true;
                console.log('Conexión restaurada, actualizando datos...');
                updateRiverData();
            });
            
            window.addEventListener('offline', () => {
                onlineStatus = false;
                console.log('Sin conexión a internet');
            });
            
            // Actualizar cuando se enfoca la pestaña
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && onlineStatus) {
                    updateRiverData();
                }
            });
            
            // Cargar datos iniciales
            await updateRiverData();
            
            // Mostrar primer puerto
            if (riverData.length > 0) {
                displayCurrentPort();
            }
            
            // Configurar intervalos
            setInterval(nextPort, DISPLAY_INTERVAL);
            setInterval(updateRiverData, UPDATE_INTERVAL);
        }

        // Iniciar aplicación
        init().catch(error => {
            console.error('Error inicializando aplicación:', error);
            portNameEl.textContent = 'ERROR DE CONEXIÓN';
            tendencyDisplayEl.textContent = 'REINTENTAR EN BREVE';
        });
    </script>
</body>
</html>